<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Data Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.0/plotly.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            margin: 0;
            padding: 0;
        }
        .chat-container { 
            height: calc(100vh - 200px); 
            overflow-y: auto; 
            background: white; 
            padding: 15px;
        }
        .chat-message { 
            margin-bottom: 20px; 
            padding: 15px; 
            border-radius: 8px; 
        }
        .question { 
            background-color: #e3f2fd; 
            border-left: 4px solid #2196F3; 
        }
        .answer-section { 
            background-color: #f1f8e9; 
            border-left: 4px solid #4CAF50; 
        }
        .error { 
            background-color: #ffebee; 
            border-left: 4px solid #f44336; 
        }
        .explanation { 
            padding: 15px; 
            background: #fff3e0; 
            border-radius: 8px; 
            margin-top: 10px;
            border-left: 4px solid #FF9800;
        }
        .single-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196F3;
            padding: 20px;
            text-align: center;
        }
        .table { 
            font-size: 0.9em; 
            margin-top: 10px; 
        }
        .chart-container { 
            margin-top: 15px; 
            min-height: 300px; 
        }
        .section-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 20px;
        }
        .input-section {
            background: white;
            padding: 15px;
            border-top: 2px solid #dee2e6;
        }
        .quick-questions {
            background: white;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h4 class="mb-0">ü¶† COVID-19 Data Assistant</h4>
        <small>Ask me anything about global COVID-19 statistics from Worldometer</small>
    </div>

    <!-- Quick Questions -->
    <div class="quick-questions">
        <div class="row g-2">
            <div class="col-6">
                <button class="btn btn-outline-danger btn-sm w-100" onclick="askQuick('Country with most cases')">
                    üìä Most Cases
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-danger btn-sm w-100" onclick="askQuick('Top 10 countries by deaths')">
                    ‚ò†Ô∏è Top Deaths
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-danger btn-sm w-100" onclick="askQuick('Total cases by continent')">
                    üåç Cases by Continent
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-danger btn-sm w-100" onclick="askQuick('Countries with most tests per million')">
                    üß™ Testing Leaders
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chat-container" class="chat-container">
        <div class="text-center text-muted p-4">
            <p>üëã Welcome! I'll help you analyze global COVID-19 data with tables, charts, and insights.</p>
            <small>Try asking: "Which continent has highest death rate?" or "Compare USA and Brazil cases"</small>
        </div>
    </div>

    <!-- Input Section -->
    <div class="input-section">
        <div class="input-group">
            <input type="text" id="questionInput" class="form-control" 
                   placeholder="Ask about COVID-19 data..." 
                   onkeypress="handleEnter(event)">
            <button class="btn btn-danger" onclick="askQuestion()">
                Ask
            </button>
        </div>
    </div>

    <script>
        function handleEnter(event) {
            if (event.key === 'Enter') {
                askQuestion();
            }
        }

        function askQuick(question) {
            document.getElementById('questionInput').value = question;
            askQuestion();
        }

        function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) return;

            input.value = '';
            addMessage('question', `<strong>Question:</strong> ${question}`);
            
            const loadingId = addMessage('loading', 'ü§ñ Analyzing COVID-19 data...');

            fetch('/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({question: question})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(loadingId).remove();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    addMessage('error', `<strong>Error:</strong> ${data.error}`);
                }
                
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            })
            .catch(error => {
                document.getElementById(loadingId).remove();
                addMessage('error', `Connection error: ${error}`);
            });
        }

        function displayResults(data) {
            const container = document.getElementById('chat-container');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'chat-message answer-section';
            
            let content = '<div class="section-title">üìä Results</div>';
            
            // Add table
            content += data.table;
            
            // Add chart if available
            if (data.chart) {
                const chartId = 'chart_' + Date.now();
                content += `<div class="chart-container" id="${chartId}"></div>`;
            }
            
            // Add explanation
            if (data.explanation) {
                content += `<div class="explanation">
                    <div class="section-title">üí° Insights</div>
                    ${data.explanation}
                </div>`;
            }
            
            resultDiv.innerHTML = content;
            container.appendChild(resultDiv);
            
            // Render chart if available
            if (data.chart) {
                const chartId = resultDiv.querySelector('.chart-container').id;
                const chartData = JSON.parse(data.chart);
                Plotly.newPlot(chartId, chartData.data, chartData.layout, {responsive: true});
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function addMessage(type, content) {
            const container = document.getElementById('chat-container');
            const messageId = 'msg_' + Date.now();
            const div = document.createElement('div');
            div.id = messageId;
            div.className = `chat-message ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
            
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }
    </script>
</body>
</html>